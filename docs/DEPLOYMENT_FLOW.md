# 🔄 Схема деплоя и обновлений

## Визуальная схема: Как работает обновление

```
┌─────────────────────────────────────────────────────────────┐
│                    ВАША РАЗРАБОТКА                          │
│  ┌──────────┐  ┌──────────┐  ┌────────────────────┐        │
│  │ Код PHP  │  │ CSS/JS   │  │ Новая миграция     │        │
│  │ (новый)  │  │ (новый)  │  │ 003_add_field.sql  │        │
│  └──────────┘  └──────────┘  └────────────────────┘        │
└─────────────────────────────────────────────────────────────┘
                          │
                          │ git push
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    GIT РЕПОЗИТОРИЙ                          │
│                  (GitHub/GitLab/etc)                        │
└─────────────────────────────────────────────────────────────┘
                          │
                          │ git pull
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    PRODUCTION СЕРВЕР                        │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  docker-compose down                                │   │
│  │  git pull                                           │   │
│  │  docker-compose up --build -d                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                          ▼                                  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │           DOCKER КОНТЕЙНЕРЫ                          │  │
│  │                                                      │  │
│  │  ┌────────────┐         ┌──────────────────┐        │  │
│  │  │ Web (PHP)  │◄────────┤ Database (MySQL) │        │  │
│  │  │            │         │                  │        │  │
│  │  │ Новый код  │         │ Docker Volume    │        │  │
│  │  │ Новый CSS  │         │ mysql_data       │        │  │
│  │  │ Новый JS   │         │                  │        │  │
│  │  └────────────┘         │ ┌──────────────┐ │        │  │
│  │        │                │ │ users        │ │        │  │
│  │        │                │ │ (100 юзеров) │ │        │  │
│  │        │                │ │ + новое поле │ │        │  │
│  │        │                │ └──────────────┘ │        │  │
│  │        │                │                  │        │  │
│  │        │                │ ┌──────────────┐ │        │  │
│  │        │                │ │ migrations   │ │        │  │
│  │        │                │ │ 001 ✓        │ │        │  │
│  │        │                │ │ 002 ✓        │ │        │  │
│  │        │                │ │ 003 ✓ NEW!   │ │        │  │
│  │        │                │ └──────────────┘ │        │  │
│  │        │                └──────────────────┘        │  │
│  │        │                                            │  │
│  │        └──► Применяет миграцию 003                 │  │
│  │             автоматически при старте                │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## Что происходит при обновлении

### 1️⃣ Остановка контейнеров

```bash
docker-compose down
```

```
┌─────────────┐
│ Web         │  ◄── Останавливается
└─────────────┘

┌─────────────┐
│ Database    │  ◄── Останавливается
└─────────────┘

┌─────────────┐
│ mysql_data  │  ◄── ОСТАЕТСЯ! (Docker Volume)
│ (все данные)│
└─────────────┘
```

### 2️⃣ Обновление кода

```bash
git pull
```

```
Старый код → Удаляется
Новый код  → Загружается
БД         → Не трогается
```

### 3️⃣ Запуск контейнеров

```bash
docker-compose up --build -d
```

```
┌─────────────┐
│ Web (новый) │  ◄── Создается заново
└─────────────┘
       │
       │ Подключается к
       ▼
┌─────────────┐
│ Database    │  ◄── Создается заново
└─────────────┘
       │
       │ Монтирует
       ▼
┌─────────────┐
│ mysql_data  │  ◄── Используется старый volume
│ (все данные)│      (все пользователи на месте!)
└─────────────┘
```

### 4️⃣ Автоматические миграции

```
При старте Web контейнера:

1. Выполняется migrate.php
2. Читает database/migrations/
3. Проверяет таблицу migrations
4. Применяет только новые миграции

┌──────────────────────────────────────┐
│ Файлы миграций                       │
├──────────────────────────────────────┤
│ 001_create_users.sql        ✓ Есть   │
│ 002_create_sessions.sql     ✓ Есть   │
│ 003_add_avatar_field.sql    ✗ Новая  │ ◄── Применится!
└──────────────────────────────────────┘
```

---

## Жизненный цикл данных

### Что сохраняется между обновлениями

```
┌─────────────────────────────────────────┐
│ Docker Volume: mysql_data               │
├─────────────────────────────────────────┤
│ ✅ Все пользователи                     │
│ ✅ Все пароли (хеши)                    │
│ ✅ История сброса паролей               │
│ ✅ Email шаблоны                        │
│ ✅ История миграций                     │
│ ✅ Все настройки                        │
└─────────────────────────────────────────┘
        │
        │ Сохраняется при:
        │
        ├─► docker-compose down
        ├─► docker-compose up --build
        ├─► Обновлении кода
        └─► Перезагрузке сервера
```

### Что НЕ сохраняется

```
┌─────────────────────────────────────────┐
│ Контейнеры (пересоздаются)              │
├─────────────────────────────────────────┤
│ ❌ Код PHP (обновляется)                │
│ ❌ CSS/JS (обновляется)                 │
│ ❌ Конфигурация Apache (обновляется)    │
│ ❌ Временные файлы                      │
└─────────────────────────────────────────┘
```

---

## Сценарии использования

### Сценарий 1: Добавление нового функционала

```
Разработка:
├─ Новый контроллер ProfileController.php
├─ Новый view profile.view.php
└─ Новая миграция 003_add_avatar.sql

Деплой:
1. git push
2. На сервере: git pull
3. docker-compose down && docker-compose up --build -d

Результат:
✅ Новый функционал работает
✅ Все старые пользователи на месте
✅ Миграция применена автоматически
```

### Сценарий 2: Исправление бага

```
Разработка:
└─ Исправлен LoginController.php

Деплой:
1. git push
2. На сервере: git pull
3. docker-compose down && docker-compose up --build -d

Результат:
✅ Баг исправлен
✅ Все данные на месте
✅ Миграции не нужны
```

### Сценарий 3: Изменение структуры БД

```
Разработка:
├─ Обновлен ProfileController.php (использует новое поле)
└─ Новая миграция 004_add_phone.sql

Деплой:
1. git push
2. На сервере: git pull
3. docker-compose down && docker-compose up --build -d

Результат:
✅ Новое поле добавлено
✅ Старые пользователи остались
✅ У всех пользователей phone = NULL (можно заполнить позже)
```

---

## Безопасность данных

### Уровни защиты

```
Уровень 1: Docker Volume
├─ Данные хранятся отдельно от кода
└─ Не удаляются при обновлении

Уровень 2: Регулярные бэкапы
├─ Автоматический бэкап каждый день
└─ Хранение бэкапов 30 дней

Уровень 3: Репликация (опционально)
├─ Master-Slave репликация MySQL
└─ Резервный сервер
```

### Что делать если что-то пошло не так

```
1. Остановите сервер
   docker-compose down

2. Восстановите БД из бэкапа
   docker-compose up -d db
   docker-compose exec -T db mysql -u app_user -p app_db < backup.sql

3. Откатите код
   git checkout previous-version

4. Запустите
   docker-compose up -d

5. Проверьте
   Все должно работать как раньше
```

---

## Мониторинг изменений

### Что отслеживать

```
┌─────────────────────────────────────────┐
│ Метрика              │ Команда          │
├──────────────────────┼──────────────────┤
│ Количество юзеров    │ SELECT COUNT(*) FROM users │
│ Размер БД            │ SHOW TABLE STATUS │
│ Примененные миграции │ SELECT * FROM migrations │
│ Логи ошибок          │ docker-compose logs │
│ Использование RAM    │ docker stats │
└─────────────────────────────────────────┘
```

---

## Резюме

### Ключевые моменты:

1. **Docker Volume** - хранит БД отдельно от кода
2. **Миграции** - применяются автоматически
3. **Данные** - сохраняются между обновлениями
4. **Бэкапы** - ваша страховка
5. **Откат** - всегда возможен

### Формула успешного обновления:

```
Бэкап → Обновление кода → Перезапуск → Проверка → Новый бэкап
```

### Что запомнить:

- ✅ `docker-compose down` - безопасно (данные остаются)
- ❌ `docker-compose down -v` - опасно (удалит данные)
- ✅ Миграции идемпотентны (можно запускать много раз)
- ✅ Всегда делайте бэкап перед обновлением
